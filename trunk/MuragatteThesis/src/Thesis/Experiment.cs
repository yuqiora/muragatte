// ------------------------------------------------------------------------
// Muragatte - A Toolkit for Observation of Swarm Behaviour
//             Thesis Application
//
// Copyright (C) 2012  Jiří Vejmola.
// Developed under the MIT License. See the file license.txt for details.
//
// Muragatte on the internet: http://code.google.com/p/muragatte/
// ------------------------------------------------------------------------

using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using Muragatte.Core;
using Muragatte.Core.Environment;
using Muragatte.Core.Storage;
using Muragatte.Random;
using Muragatte.Visual.Styles;

namespace Muragatte.Thesis
{
    public class Experiment
    {
        #region Fields

        private string _sName;
        private string _sPath;
        private int _iRepeatCount;
        private int _iLength;
        private InstanceDefinition _definition;
        private List<Instance> _instances = new List<Instance>();
        private List<Style> _styles;
        private bool _bComplete = false;
        private ExperimentResults _results = null;
        private uint _uiSeed;
        private RandomMT _random;

        #endregion

        #region Constructors

        public Experiment(string name, string path, int repeat, int length, InstanceDefinition definition, IEnumerable<Style> styles, uint seed)
        {
            _sName = name;
            _sPath = path;
            _iRepeatCount = repeat;
            _iLength = length;
            _definition = definition;
            _styles = styles == null ? new List<Style>() : new List<Style>(styles);
            _uiSeed = seed;
            _random = new RandomMT(_uiSeed);
        }

        #endregion

        #region Properties

        public string Name
        {
            get { return _sName; }
            set { _sName = value; }
        }

        public string Path
        {
            get { return _sPath; }
            set { _sPath = value; }
        }

        public int RepeatCount
        {
            get { return _iRepeatCount; }
        }

        public int Length
        {
            get { return _iLength; }
        }

        public List<Instance> Instances
        {
            get { return _instances; }
        }

        public IEnumerable<Style> Styles
        {
            get { return _styles; }
        }

        public bool IsComplete
        {
            get { return _bComplete; }
        }

        public uint Seed
        {
            get { return _uiSeed; }
        }

        public ExperimentResults Results
        {
            get { return _results; }
        }

        #endregion

        #region Methods

        public void Run()
        {
            if (!_bComplete)
            {
                //if (_instances.Count > 0 && !_instances.Last().IsComplete)
                //{
                //    _instances.Last().Run();
                //}
                for (int i = _instances.Count; i < _iRepeatCount; i++)
                {
                    CreateNewInstance(i);
                    _instances[i].Run();
                }
                //results post-processing
                ProcessResults();
                _bComplete = true;
            }
        }

        private void CreateNewInstance(int number)
        {
            //seed to be generated by rng
            _instances.Add(_definition.CreateInstance(number, _iLength, _uiSeed));
        }

        private void ProcessResults() { }

        #endregion
    }

    public class ExperimentResults { }

    public class Instance
    {
        #region Fields

        private int _iNumber;
        private int _iLength;
        private MultiAgentSystem _mas;
        private bool _bComplete = false;
        private InstanceResults _results = null;
        private uint _uiSeed;
        private RandomMT _random;

        #endregion

        #region Constructors

        public Instance(int number, int length, double timePerStep, Scene scene, IEnumerable<AgentArchetype> archetypes, SpeciesCollection species, uint seed)
        {
            _iNumber = number;
            _iLength = length;
            _uiSeed = seed;
            _random = new RandomMT(_uiSeed);
            //storage type fixed for now, might be selectable in the future
            _mas = new MultiAgentSystem(new SimpleBruteForceStorage(scene.StationaryElements), scene.Region, species, _random, timePerStep);
            AgentsFromArchetypes(scene.StationaryElements.Count, archetypes);
            _mas.Initialize();
        }

        public Instance(int number, int length, InstanceDefinition definition, uint seed)
            : this(number, length, definition.TimePerStep, definition.Scene, definition.Archetypes, definition.Species, seed) { }

        #endregion

        #region Properties

        public int Number
        {
            get { return _iNumber; }
        }

        public int Length
        {
            get { return _iLength; }
        }

        public MultiAgentSystem Model
        {
            get { return _mas; }
        }

        public bool IsComplete
        {
            get { return _bComplete; }
        }

        public InstanceResults Results
        {
            get { return _results; }
        }

        public uint Seed
        {
            get { return _uiSeed; }
        }

        #endregion

        #region Methods

        public void Run()
        {
            if (!_bComplete)
            {
                for (int i = _mas.StepCount; i < _iLength; i++)
                {
                    _mas.Update();
                }
                //results post-processing
                ProcessResults();
                _bComplete = true;
            }
        }

        private void AgentsFromArchetypes(int startID, IEnumerable<AgentArchetype> archetypes)
        {
            foreach (AgentArchetype a in archetypes)
            {
                _mas.Elements.Add(a.CreateAgents(startID, _mas));
                startID += a.Count;
            }
        }

        private void ProcessResults() { }

        #endregion
    }

    public class InstanceResults { }

    public class InstanceDefinition
    {
        #region Fields

        private double _dTimePerStep;
        private Scene _scene = null;
        private SpeciesCollection _species;
        private List<AgentArchetype> _archetypes = new List<AgentArchetype>();

        #endregion

        #region Constructors

        public InstanceDefinition(double timePerStep, Scene scene, SpeciesCollection species, IEnumerable<AgentArchetype> archetypes)
        {
            _dTimePerStep = timePerStep;
            _scene = scene;
            _species = species;
            _archetypes = archetypes == null ? new List<AgentArchetype>() : new List<AgentArchetype>(archetypes);
        }

        #endregion

        #region Properties

        public double TimePerStep
        {
            get { return _dTimePerStep; }
        }

        public Scene Scene
        {
            get { return _scene; }
        }

        public SpeciesCollection Species
        {
            get { return _species; }
        }

        public List<AgentArchetype> Archetypes
        {
            get { return _archetypes; }
        }

        #endregion

        #region Methods

        public Instance CreateInstance(int number, int length, uint seed)
        {
            return new Instance(number, length, _dTimePerStep, _scene, _archetypes, _species, seed);
        }

        #endregion
    }
}
